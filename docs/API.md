# HEX API

Документ описывает ключевые публичные эндпоинты прототипа HEX и то, как они связываются с пользовательским интерфейсом try-on.

## Общие сведения
- Базовый URL: `http://localhost:4000` при локальном запуске `npm run server`.
- Ответы возвращаются в формате JSON, если не указано иное.
- Таймаут сервисов try-on: ~2.5 сек (по истечении отдаётся `504`).

## GET `/api/product/parse?url=`
Парсит карточку товара с маркетплейсов (Wildberries/Ozon/Lamoda) и готовит данные для экрана try-on.

### Параметры запроса
- `url` (query, обязательный): ссылка на товар.

### Структура успешного ответа
```json
{
  "title": "Футболка HEX",
  "article": "ART-123",
  "price": 2990,
  "originalPrice": 3990,
  "discount": 25,
  "images": ["https://.../image1.jpg"],
  "similar": [{ "title": "Похожий образ", "price": 3190, "image": "https://..." }],
  "sizes": ["S", "M", "L"],
  "recommendedSize": "M",
  "recommendationConfidence": 0.82,
  "fitNotes": ["Лучше сидит оверсайз"],
  "marketplace": "ozon"
}
```

### Ошибки
- `400 Bad Request` — отсутствует параметр `url` или он пустой.
- `502 Bad Gateway` — не удалось загрузить карточку товара (ошибка сети/редиректов).
- `504 Gateway Timeout` — превышено ~7 секунд ожидания ответа от маркетплейса.
- `500 Internal Server Error` — парсер маркетплейса вернул ошибку/недоступен.

### Пример запроса
```bash
curl -G "http://localhost:4000/api/product/parse" \
  --data-urlencode "url=https://www.ozon.ru/product/example"
```

## POST `/api/tryon/2d`
Запускает 2D-примерку по фото пользователя. Запрос — `multipart/form-data`.

### Поля формы
- `image` (обязательное): файл изображения. Ограничение — до 15 МБ; принимаются только MIME, начинающиеся с `image/`.
- `suggestedSize` (опционально): подсказка по размеру для повышения точности.

### Структура успешного ответа
```json
{
  "previewUrl": "/api/tryon/2d/preview/7e5a...",
  "recommendedSize": "M",
  "confidence": 0.9,
  "recommendation": "Рекомендуем размер M: примерка учла пропорции силуэта и плотность ткани.",
  "status": "completed",
  "statusMessage": "Примерка успешно завершена."
}
```

- `previewUrl` — ссылка на сжатый предпросмотр, отдаваемый CDN/прокси. Файл ресайзится и сохраняется во временное хранилище;
  ссылка действует, пока файл доступен на сервере.

### Ошибки
- `400 Bad Request` — поле `image` отсутствует/неверно названо или MIME не является изображением.
- `413 Payload Too Large` — размер файла превышает 15 МБ.
- `504 Gateway Timeout` — таймаут обработки примерки.
- `500 Internal Server Error` — непредвиденная ошибка сервиса примерки.

### Пример запроса
```bash
curl -X POST "http://localhost:4000/api/tryon/2d" \
  -F "image=@/path/to/photo.jpg" \
  -F "suggestedSize=M"
```

## POST `/api/tryon/3d`
Строит 3D-модель и подбирает размер на основе параметров тела.

### Тело запроса (JSON)
- `gender` (обязательный): `male` или `female`.
- `height` (обязательный): рост, см (120–230).
- `weight` (обязательный): вес, кг (30–250).
- `chest` (обязательный): обхват груди, см (60–160).
- `waist` (обязательный): обхват талии, см (50–160).
- `hips` (обязательный): обхват бёдер, см (60–180).
- `suggestedSize` (опционально): подсказка по размеру.
- `saveParams` (опционально): boolean, сохранить параметры профиля.

### Валидация и сообщения
- Неверный `gender` → `Укажите пол: male или female.`
- Числовые поля пустые/не числа → `Рост/Вес/Грудь/...: введите число.`
- Выход за пределы диапазона → сообщения вида `Рост: значение не может быть ниже 120.`

### Структура успешного ответа
```json
{
  "recommendedSize": "L",
  "confidence": 0.94,
  "renderedImage": "https://images.../render.jpg",
  "fitMetrics": [
    { "label": "По груди", "status": "Комфортно", "score": 82, "detail": "Обхват груди 102 см vs. размерная сетка 100 см" },
    { "label": "По талии", "status": "Плотно", "score": 65, "detail": "Талия 84 см vs. 78 см в выбранном размере" }
  ],
  "status": "completed",
  "statusMessage": "3D-примерка завершена."
}
```

### Ошибки
- `400 Bad Request` — тело не прошло валидацию; ответ содержит `message` и объект `errors` по полям.
- `504 Gateway Timeout` — превышен таймаут 3D-сервиса.
- `500 Internal Server Error` — сервис 3D-примерки временно недоступен.

### Пример запроса
```bash
curl -X POST "http://localhost:4000/api/tryon/3d" \
  -H "Content-Type: application/json" \
  -d '{
    "gender": "female",
    "height": 170,
    "weight": 62,
    "chest": 90,
    "waist": 70,
    "hips": 98,
    "suggestedSize": "M"
  }'
```

## Связка с фронтендом
- Пользователь вводит ссылку на товар и после валидации перенаправляется на страницу `/try-on?url=...`, где запрашиваются данные через `GET /api/product/parse`.
- На странице try-on доступно открытие модалок «2D Примерка» и «3D Подбор», которые отправляют соответствующие запросы `/api/tryon/2d` и `/api/tryon/3d` и подставляют рекомендации в карточку товара.
