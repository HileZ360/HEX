# HEX — AI try-on платформа для e-commerce

**HEX** — прототип уровня production для виртуальной примерки одежды. Принимает ссылки на товары (Wildberries/Ozon/Lamoda), парсит карточки, подбирает размеры, выполняет 2D/3D try-on через настраиваемых AI‑провайдеров и возвращает готовые рекомендации. Репозиторий ориентирован на быстрый запуск, демонстрационные сценарии и дальнейшее масштабирование.

## Оглавление
- [Обзор продукта](#обзор-продукта)
- [Архитектура и компоненты](#архитектура-и-компоненты)
- [Требования и окружения](#требования-и-окружения)
- [Быстрый старт](#быстрый-старт)
- [Скрипты npm](#скрипты-npm)
- [Настройки и переменные окружения](#настройки-и-переменные-окружения)
- [API](#api)
- [Структура проекта](#структура-проекта)
- [Качество и тестирование](#качество-и-тестирование)
- [Операционная готовность](#операционная-готовность)
- [Дорожная карта](#дорожная-карта)

## Обзор продукта
- Поддержка ссылок маркетплейсов с унифицированным парсером и fallback на HTML-извлечение.
- AI‑подбор размеров и отображение совместимости для выбранных товаров.
- 2D try-on по фотографии и 3D примерка по параметрам тела через подключаемых провайдеров.
- Ограничение запросов, кеширование и повторное использование результатов для стабильности под нагрузкой.

## Архитектура и компоненты
**Фронтенд** (React 18 + Vite + Tailwind CSS)
- Лендинг с анимированным hero-блоком и валидацией ссылок Wildberries/Ozon/Lamoda.
- Навигация на экран примерки и интерактивные элементы с анимациями (Framer Motion/GSAP).
- Локализация через i18next и state-менеджмент на Zustand.

**Сервер** (Fastify, TypeScript)
- Адаптеры маркетплейсов в `server/services/adapters` с нормализацией данных.
- Rate limit/очереди на парсинг, кеширование результатов и управление таймаутами.
- Конфигурируемые AI‑провайдеры 2D/3D примерки с авторизацией по токену и защитой таймаутами.

**Данные и кэш**
- Краткосрочное хранение предпросмотров с управлением TTL/лимитами (`PREVIEW_*`).
- TTL-кеш парсинга товаров (`PARSED_PRODUCT_*`) для снижения нагрузки на внешние источники.

## Требования и окружения
- Node.js **20.19+** (Node 18 не поддерживается из-за Vite/undici).
- npm **10+** (зафиксировано в `packageManager`).
- Рекомендуемое окружение: macOS/Linux, локальная разработка через Vite dev server и отдельный Fastify сервер.

## Быстрый старт
```bash
npm install              # установка зависимостей
npm run dev              # фронтенд в dev-режиме (Vite, по умолчанию порт 5173)
npm run server           # API-сервер Fastify (порт 4000 по умолчанию)
# Дополнительно
npm run build            # сборка фронтенда
npm run preview          # предпросмотр прод-сборки
```

## Скрипты npm
| Команда | Назначение |
| --- | --- |
| `npm run dev` | Запуск фронтенда в режиме разработки (Vite). |
| `npm run server` | Запуск API-сервера Fastify. |
| `npm run build` | Сборка SPA. |
| `npm run preview` | Предпросмотр собранной версии. |
| `npm test` | Unit-тесты (Node.js test runner через tsx). |

## Настройки и переменные окружения
Минимально обязательные:
- `TRY_ON_API_URL` — базовый endpoint провайдера примерки.
- `TRY_ON_API_TOKEN` — токен авторизации провайдера.

Рекомендуемые/опциональные:
- `TRY_ON_3D_API_URL` — отдельный endpoint для 3D try-on (иначе используется `TRY_ON_API_URL`).
- `TRY_ON_TIMEOUT_MS`, `TRY_ON_PROVIDER_TIMEOUT_MS` — таймауты запросов к провайдерам (мс).
- `CATVTON_API_URL`, `CATVTON_API_TOKEN`, `CATVTON_TIMEOUT_MS` — альтернативный провайдер примерки.
- `PREVIEW_*` (например, `PREVIEW_RETENTION_MINUTES`, `PREVIEW_MAX_COUNT`, `PREVIEW_TOKEN_SECRET`) — управление хранением предпросмотров и токенами загрузки.
- `PRODUCT_*` (например, `PRODUCT_RATE_LIMIT_MAX`, `PRODUCT_PARSE_MAX_CONCURRENCY`, `PRODUCT_URL_MAX_LENGTH`) — настройки очередей/ограничений парсинга карточек.
- `PARSED_PRODUCT_TTL_MS`, `PARSED_PRODUCT_CACHE_LIMIT` — кеширование результатов парсинга.
- `PORT` — порт Fastify (по умолчанию 4000).

## API
- `GET /api/product/parse?url=` — парсинг карточки товара и рекомендации размеров.
- `POST /api/tryon/2d` — 2D примерка по фото (multipart, поле `image`).
- `POST /api/tryon/3d` — 3D примерка по параметрам тела.

Детальные параметры, коды ошибок и примеры запросов: [docs/API.md](docs/API.md).

## Структура проекта
- `src/` — клиентское приложение (страницы, компоненты, хуки, утилиты).
- `server/` — Fastify-сервер, интеграции с маркетплейсами и AI.
  - `server/services/adapters/` — адаптеры маркетплейсов, регистрируются в `index.ts`.
  - `server/parsers/`, `server/normalizers/` — извлечение и нормализация данных карточек.
- `docs/` — сопутствующая документация (например, `API.md`).
- `test/` — модульные тесты (см. пример `test/services.adapters.wildberries.test.ts`).

## Качество и тестирование
- Локальный запуск: `npm test`.
- Перед коммитом прогоняйте сборку (`npm run build`) и базовые e2e-сценарии фронтенда/бэкенда с реальными API-ключами.
- Вынесите таймауты, rate limit'ы и ключи провайдеров в переменные окружения для безопасного нагрузочного тестирования.

## Операционная готовность
- **Надёжность:** таймауты и ограничения concurrency для предотвращения зависаний и перегрузки внешних сервисов.
- **Производительность:** TTL-кеш парсинга товаров снижает обращения к маркетплейсам, повторное использование результатов try-on уменьшает латентность.
- **Безопасность:** токены провайдеров принимаются только из переменных окружения; multipart-аплоады ограничены Fastify и прокси-настройками.
- **Наблюдаемость:** ошибки и ключевые события логируются на сервере; рекомендуются сторонние APM/лог-агрегаторы при деплое.

## Дорожная карта
- Улучшение точности try-on и скорости отклика.
- Расширение поддержки маркетплейсов и брендов через новые адаптеры.
- Личный кабинет с историей примерок и аналитикой конверсии.
- A/B-тестирование рекомендаций и мониторинг качества в продакшене.
